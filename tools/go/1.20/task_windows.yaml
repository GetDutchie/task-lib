---
version: "3"

tasks:
  install:
    status:
      - |
        powershell '
          $results = go version | Select-String "go version go1.20"
          if ($results -eq $null) {
            Exit 1
          }
        '
    silent: true
    vars:
      MSI: go1.20.7.windows-amd64.msi
      URL: https://go.dev/dl/go1.20.7.windows-amd64.msi
      CHECKSUM: f5c24c6ff240f6d4b94a2bd92ba97f5d7ae01f058b3ea38438c0a2ae84e3c368
      PS_SCRIPT: |
        $parent = [System.IO.Path]::GetTempPath()
        $name = [System.IO.Path]::GetRandomFileName()
        $path = (Join-Path $parent $name)
        New-Item -ItemType Directory -Path $path | Out-Null

        $msi_path = (Join-Path $path "{{.MSI}}")
        Write-Output "Downloading to $msi_path"
        $ProgressPreference = "SilentlyContinue"
        Invoke-WebRequest -Uri "{{.URL}}" -OutFile $msi_path

        Write-Output "Verifying Checksum"
        $FileHash = Get-FileHash $msi_path
        if ($FileHash.Hash -ne "{{.CHECKSUM}}") {
          Write-Output "Checksums don't match, won't install."
          Exit 1
        }

        Write-Output "Running installer"
        msiexec /i $msi_path /quiet
    cmds:
      - powershell '{{.PS_SCRIPT}}'