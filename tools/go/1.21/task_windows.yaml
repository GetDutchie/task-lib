---
version: "3"

tasks:
  install:
    status:
      - |
        powershell '
          $results = go version | Select-String "go version go1.21"
          if ($results -eq $null) {
            Exit 1
          }
        '
    silent: true
    vars:
      MSI: go1.21.0.windows-amd64.msi
      URL: https://go.dev/dl/go1.21.0.windows-amd64.msi
      CHECKSUM: 3428c547527a4513597b921e46138c835d6e7636f93265ff96e23d0bdf0863a4
      PS_SCRIPT: |
        $parent = [System.IO.Path]::GetTempPath()
        $name = [System.IO.Path]::GetRandomFileName()
        $path = (Join-Path $parent $name)
        New-Item -ItemType Directory -Path $path | Out-Null

        $msi_path = (Join-Path $path "{{.MSI}}")
        Write-Output "Downloading to $msi_path"
        $ProgressPreference = "SilentlyContinue"
        Invoke-WebRequest -Uri "{{.URL}}" -OutFile $msi_path

        Write-Output "Verifying Checksum"
        $FileHash = Get-FileHash $msi_path
        if ($FileHash.Hash -ne "{{.CHECKSUM}}") {
          Write-Output "Checksums don't match, won't install."
          Exit 1
        }

        Write-Output "Running installer"
        $log_path = (Join-Path $parent "msiexec.log")
        Start-Process -FilePath "msiexec.exe" -Wait -ArgumentList "/i $msi_path /passive /l*v $log_path"
    cmds:
      - powershell '{{.PS_SCRIPT}}'